@entity_x = 0
@entity_y = -20

nanite_gateway = {
	entity = "gatebuilder_01_gateway_entity"
	construction_entity = "gatebuilder_01_gateway_entity"
	portrait = "GFX_megastructure_construction_background"
	place_entity_on_planet_plane = no
	build_outside_gravity_well = yes
	show_galactic_map_icon = no
	show_in_outliner = no
	construction_blocks_and_blocked_by = none
	build_time = 720
	resources = { category = megastructures cost = { nanites = 1200 energy = 1000 minerals = 1000 } }
	# upgrade_from = { lgate_disabled }
	prerequisites = { "tech_nanite_gate" } # "tech_lgate_construction"
	potential = {
		OR = {
			has_global_flag = l_cluster_opened
			has_ascension_perk = ap_emergency_calculation
		}
		OR = {
			has_technology = tech_nanite_gate
			has_technology = tech_lgate_construction # ADT
		}
	}
	possible = {
		exists = starbase
		custom_tooltip = { fail_text = "requires_inside_border" is_inside_border = from }
		custom_tooltip = { fail_text = "requires_surveyed_system" NOT = { any_system_planet = { is_surveyed = { who = prev.from status = no } } } }
		custom_tooltip = { fail_text = "requires_no_existing_gateway" NOT = { has_megastructure = nanite_gateway } }
		custom_tooltip = { fail_text = "requires_technology_gateway_construction" from = { has_technology = tech_nanite_gate } }
	}
	bypass_type = lgate # nanite_gateway
	on_build_complete = {
		from = {
			if = {
				limit = {
					has_global_flag = l_cluster_opened
					OR = {
						has_ascension_perk = ap_nano_to_nanite
						has_technology = tech_nanite_gate
						has_technology = tech_lgate_construction # ADT
					}
					NOT = { has_ascension_perk = ap_emergency_calculation }
				}
				country_event = { id = UniqueAscensionPerksEvents.8003 }
			} else = { # if = { limit = { has_ascension_perk = ap_emergency_calculation }
				country_event = { id = UniqueAscensionPerksEvents.8054 }
			}
		}
	}
}

nanite_factory_site = {
	entity = "construction_platform_entity"
	construction_entity = "construction_platform_entity"
	portrait = "GFX_megastructure_construction_background"
	place_entity_on_planet_plane = no
	construction_blocks_and_blocked_by = none
	entity_offset = { x = @entity_x y = @entity_y }
	build_time = 1800
	resources = { category = megastructures cost = { alloys = 5000 nanites = 500 influence = 150 } upkeep = { energy = 5 } }
	prerequisites = { "tech_nanite_factory" }
	# potential = { has_technology = tech_nanite_factory }
	possible = {
		exists = starbase
		custom_tooltip = { fail_text = "requires_inside_border" is_inside_border = from }
		custom_tooltip = { fail_text = "requires_surveyed_system" NOT = { any_system_planet = { is_surveyed = { who = prev.from status = no } } } }
	}
	placement_rules = {
		planet_possible = {
			custom_tooltip = { fail_text = "requires_no_anomaly" has_anomaly = no }
			custom_tooltip = { fail_text = "requires_not_minor_planetary_body" NOR = { is_asteroid = yes is_moon = yes } }
			custom_tooltip = { fail_text = "requires_not_star" is_star = no }
			custom_tooltip = { fail_text = "requires_not_ring_world" has_ringworld_output_boost = no }
			if = { limit = { from = { is_ai = yes } }
				OR = {
					has_deposit_for = shipclass_mining_station
	 				has_deposit_for = shipclass_research_station
				}
			}
		}
	}
	ai_weight = { factor = event_target:global_event_country.ap_nano_to_nanite }
	on_build_start = {}
	on_build_cancel = {}
	on_build_complete = { fromfrom.planet = { set_planet_flag = has_megastructure } from = { country_event = { id = UniqueAscensionPerksEvents.8004 } } }
}

nanite_factory = {
	entity = "gatebuilder_01_space_station_section_entity"
	construction_entity = "gatebuilder_01_space_station_section_entity"
	portrait = "GFX_megastructure_construction_background"
	place_entity_on_planet_plane = no
	construction_blocks_and_blocked_by = none
	entity_offset = { x = @entity_x y = @entity_y }
	upgrade_from = { nanite_factory_site }
	build_time = 3600
	resources = { category = megastructures cost = { alloys = 10000 nanites = 5000 } upkeep = { energy = 25 minerals = 75 } produces = { nanites = 350 alloys = 50 } }
	prerequisites = { "tech_nanite_factory" }
	# potential = { has_technology = tech_nanite_factory }
	on_build_complete = { from = { country_event = { id = UniqueAscensionPerksEvents.8005 } } }
}
